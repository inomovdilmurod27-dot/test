<!DOCTYPE html>
<html lang="uz">
<head>
<meta charset="UTF-8">
<title>GTI va NS</title>
<style>
    body { font-family: 'Segoe UI', 'Roboto', 'Arial', sans-serif; background: #f4f6f8; margin:0; padding:0; line-height:1.6; color:#333; }
    header { background:#4a90e2; color:white; padding:20px; text-align:center; font-size:1.7em; font-weight:bold; box-shadow:0 2px 5px rgba(0,0,0,0.2);}
    main { padding:25px; max-width:950px; margin:auto; }
    label { font-weight:bold; margin-top:12px; display:block; font-size:1.05em;}
    select, input, textarea, button { width:100%; margin-top:6px; margin-bottom:12px; padding:10px; border-radius:8px; border:1px solid #ccc; font-size:1em; box-sizing:border-box; font-family:'Segoe UI','Roboto','Arial',sans-serif; }
    button { background-color:#4a90e2; color:white; border:none; cursor:pointer; font-weight:bold; transition:0.3s; font-size:1.05em; }
    button:hover { background-color:#357ab8; }
    textarea { min-height:180px; resize:vertical; font-size:1em; line-height:1.5; }
    .modal { display:none; position:fixed; z-index:999; left:0; top:0; width:100%; height:100%; overflow:auto; background-color: rgba(0,0,0,0.6); animation: fadeIn 0.4s; }
    .modal-content { background-color:#fff; margin:60px auto; padding:30px; border-radius:15px; border:1px solid #888; width:90%; max-width:950px; max-height:80%; overflow-y:auto; white-space:pre-wrap; font-family:'Segoe UI','Roboto','Arial',monospace; box-shadow:0 8px 25px rgba(0,0,0,0.3); animation: slideDown 0.4s ease; font-size:1em; line-height:1.5; }
    @keyframes slideDown { from {transform:translateY(-50px); opacity:0;} to {transform:translateY(0); opacity:1;} }
    @keyframes fadeIn { from{opacity:0;} to{opacity:1;} }
    .close { color:#444; float:right; font-size:32px; font-weight:bold; cursor:pointer; transition:0.2s;}
    .close:hover { color:#000; }
    h2 { color:#333; margin-bottom:15px; font-size:1.3em; }
    .section { background:#fff; padding:25px; margin-bottom:25px; border-radius:12px; box-shadow:0 3px 8px rgba(0,0,0,0.1); }
    .question { background-color:#e6f0ff; margin-bottom:10px; padding:10px; border-radius:6px; transition:0.3s; font-size:1.05em; }
    .question:hover { background-color:#cce0ff; }
    .answer { background-color:#f0f0f0; margin-left:20px; padding:6px; border-radius:4px; margin-bottom:4px; font-size:1em; }
    .summary-header { font-weight:bold; margin-top:20px; font-size:1.1em; color:#333; }
    #errorDiv { background:#fff3cd; border:1px solid #ffeeba; padding:15px; border-radius:8px; margin-top:15px; color:#856404; font-size:1em; }
    .repeat { color:red; margin-left:0; font-weight:bold; }
</style>
</head>
<body>

<header>GTI va NS kafedrasi</header>

<main>
    <div class="section">
        <h2>Sozlamalar</h2>

        <label>Raqamlash:</label>
        <select id="numbering">
            <option value="yes">Ha</option>
            <option value="no">Yo‘q</option>
        </select>

        <label>Variantlar (a, b, c…)</label>
        <select id="abcMode">
            <option value="yes">Ha</option>
            <option value="no">Yo‘q</option>
        </select>

        <label>Savollar orasida bo‘sh qator qo‘yilsinmi?</label>
        <select id="addEnter">
            <option value="yes">Ha</option>
            <option value="no">Yo‘q</option>
        </select>

        <label>Savol oldidagi belgi:</label>
        <input id="blockPrefix" value="++++">

        <label>To'g'ri javob oldidagi belgi:</label>
        <input id="firstPrefix" value="====#">

        <label>Noto'g'ri javob oldidagi belgir:</label>
        <input id="otherPrefix" value="====">
    </div>

    <div class="section">
        <h2>Savollarni kiriting</h2>
        <textarea id="inputText" placeholder="Savollarni kiriting..."></textarea>
        <button onclick="showResult()">Natijani Ko‘rish</button>
        <div id="errorDiv"></div>
    </div>
</main>

<div id="resultModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeModal()">&times;</span>
    <div id="modalText"></div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script>
function getABC(index) { return String.fromCharCode(97 + index) + ") "; }

function customFormat(text, index, numbering, abcMode, blockPrefix, firstPrefix, otherPrefix) {
    let lines = text.trim().split("\n");
    if (lines.length === 0) return [];
    let out = [];
    let title = lines[0];
    if(numbering==="yes") title = index + ". " + title;
    out.push(blockPrefix + title);
    for(let i=1;i<lines.length;i++){
        let line = lines[i];
        if(abcMode==="yes") line = getABC(i-1)+line;
        let prefix = (i===1) ? firstPrefix : otherPrefix;
        out.push(prefix + line);
    }
    return out;
}

function splitBlocks(text){
    let lines=text.split("\n");
    let blocks=[]; let current=[];
    for(let i=0;i<lines.length;i++){
        let line=lines[i].trim();
        if(line==="") continue;
        if(line.endsWith("?") && current.length>0){
            blocks.push(current); current=[line];
        } else current.push(line);
    }
    if(current.length>0) blocks.push(current);
    return blocks;
}

function showResult(){
    let input=document.getElementById("inputText").value.trim();
    let numbering=document.getElementById("numbering").value;
    let abcMode=document.getElementById("abcMode").value;
    let addEnter=document.getElementById("addEnter").value;
    let blockPrefix=document.getElementById("blockPrefix").value;
    let firstPrefix=document.getElementById("firstPrefix").value;
    let otherPrefix=document.getElementById("otherPrefix").value;

    let blocks=splitBlocks(input);
    let modalDiv=document.getElementById("modalText");
    modalDiv.innerHTML="";

    let manyAnswer=[]; let fewAnswer=[];

    blocks.forEach((blk,i)=>{
        let formatted = customFormat(
            blk.join("\n"), i+1, numbering, abcMode,
            blockPrefix, firstPrefix, otherPrefix
        );
        let numAnswers=blk.length-1;

        if(numAnswers>4) manyAnswer.push(i+1+". "+blk[0]);
        else if(numAnswers<4) fewAnswer.push(i+1+". "+blk[0]);

        let qDiv=document.createElement("div");
        qDiv.className="question";
        qDiv.innerHTML=formatted[0];
        modalDiv.appendChild(qDiv);

        for(let j=1;j<formatted.length;j++){
            let aDiv=document.createElement("div");
            aDiv.className="answer";
            aDiv.innerHTML=formatted[j];
            modalDiv.appendChild(aDiv);
        }

        if(addEnter==="yes" && i!=blocks.length-1) modalDiv.appendChild(document.createElement("br"));
    });

    document.getElementById("resultModal").style.display="block";

    let errorDiv=document.getElementById("errorDiv");
    errorDiv.innerHTML="";

    let questionMap = {};
    blocks.forEach((blk, index)=>{
        let qText = blk[0].trim();
        if(questionMap[qText]) questionMap[qText].push(index+1);
        else questionMap[qText]=[index+1];
    });

    let repeatedQuestions = [];
    for(let q in questionMap){
        if(questionMap[q].length>1){
            questionMap[q].forEach(num=>{
                repeatedQuestions.push(num+". "+q);
            });
        }
    }

    if(manyAnswer.length>0 || fewAnswer.length>0 || repeatedQuestions.length>0){
        let html="<strong>Xato va takror savollar:</strong><br>";
        if(manyAnswer.length>0){
            html+="<em>4 tadan ko‘p javobli savollar:</em><br>"+manyAnswer.join("<br>")+"<br>";
        }
        if(fewAnswer.length>0){
            html+="<em>4 tadan kam javobli savollar:</em><br>"+fewAnswer.join("<br>")+"<br>";
        }
        if(repeatedQuestions.length>0){
            html+="<em>Takror savollar:</em><br>";
            repeatedQuestions.forEach(q=>{
                html+='<span class="repeat">'+q+'</span><br>';
            });
        }
        errorDiv.innerHTML=html;
    }
}

// DOWNLOAD FUNKSIYALARI (Oxirida)
function downloadResult(format) {
    let modalDiv = document.getElementById("modalText");
    if (!modalDiv.innerHTML.trim()) {
        alert("Natija mavjud emas!");
        return;
    }

    let htmlContent = modalDiv.innerHTML.replace(/<div class="question">/g,"")
                                        .replace(/<div class="answer">/g,"")
                                        .replace(/<\/div>/g,"")
                                        .replace(/<br>/g,"\n");

    if (format === 'txt') {
        let blob = new Blob([htmlContent], { type: "text/plain;charset=utf-8" });
        let link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "natija.txt";
        link.click();
    } 
    else if (format === 'doc') {
        let docHtml = "<html><head><meta charset='UTF-8'></head><body>" + modalDiv.innerHTML + "</body></html>";
        let blob = new Blob([docHtml], { type: "application/msword" });
        let link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "natija.doc";
        link.click();
    } 
    else if (format === 'xlsx') {
        let wb = XLSX.utils.book_new();
        let rows = [];
        modalDiv.querySelectorAll(".question, .answer").forEach(el=>{
            rows.push([el.textContent]);
        });
        XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(rows), "Natija");
        XLSX.writeFile(wb, "natija.xlsx");
    }
}

function closeModal(){ document.getElementById("resultModal").style.display="none"; }
window.onclick=function(event){ if(event.target==document.getElementById("resultModal")) closeModal();}
</script>

<div style="padding:25px; max-width:950px; margin:auto;">
    <button onclick="downloadResult('txt')">Yuklab olish (TXT)</button>
    <button onclick="downloadResult('doc')">Yuklab olish (DOC)</button>
    <button onclick="downloadResult('xlsx')">Yuklab olish (Excel)</button>
</div>

</body>
</html>
