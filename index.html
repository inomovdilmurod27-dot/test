<!DOCTYPE html>
<html lang="uz">
<head>
<meta charset="UTF-8">
<title>GTI va NS</title>
<style>
    body { font-family:'Segoe UI','Roboto','Arial',sans-serif; background:#f4f6f8; margin:0; padding:0; line-height:1.6; color:#333; }
    header { background:#4a90e2; color:white; padding:20px; text-align:center; font-size:1.7em; font-weight:bold; box-shadow:0 2px 5px rgba(0,0,0,0.2);}    
    main { padding:25px; max-width:950px; margin:auto; }
    label { font-weight:bold; margin-top:12px; display:block; font-size:1.05em;}
    select, input, textarea, button { width:100%; margin-top:6px; margin-bottom:12px; padding:10px; border-radius:8px; border:1px solid #ccc; font-size:1em; box-sizing:border-box; font-family:'Segoe UI','Roboto','Arial',sans-serif; }
    button { background-color:#4a90e2; color:white; border:none; cursor:pointer; font-weight:bold; transition:0.3s; font-size:1.05em; }
    button:hover { background-color:#357ab8; }
    textarea { min-height:180px; resize:vertical; font-size:1em; line-height:1.5; }
    .modal { display:none; position:fixed; z-index:999; left:0; top:0; width:100%; height:100%; overflow:auto; background-color: rgba(0,0,0,0.6); animation: fadeIn 0.4s; }
    .modal-content { background-color:#fff; margin:60px auto; padding:30px; border-radius:15px; border:1px solid #888; width:90%; max-width:950px; max-height:80%; overflow-y:auto; white-space:pre-wrap; font-family:'Segoe UI','Roboto','Arial',monospace; box-shadow:0 8px 25px rgba(0,0,0,0.3); animation: slideDown 0.4s ease; font-size:1em; line-height:1.5; }
    @keyframes slideDown { from {transform:translateY(-50px); opacity:0;} to {transform:translateY(0); opacity:1;} }
    @keyframes fadeIn { from{opacity:0;} to{opacity:1;} }
    .close { color:#444; float:right; font-size:32px; font-weight:bold; cursor:pointer; transition:0.2s;}
    .close:hover { color:#000; }
    h2 { color:#333; margin-bottom:15px; font-size:1.3em; }
    .section { background:#fff; padding:25px; margin-bottom:25px; border-radius:12px; box-shadow:0 3px 8px rgba(0,0,0,0.1); }
    .question { background-color:#e6f0ff; margin-bottom:10px; padding:10px; border-radius:6px; transition:0.3s; font-size:1.05em; }
    .answer { background-color:#f0f0f0; margin-left:20px; padding:6px; border-radius:4px; margin-bottom:4px; font-size:1em; }
    .keyword { color:green; font-weight:bold; }
    .repeat { color:red; font-weight:bold; }
    #errorDiv { background:#fff3cd; border:1px solid #ffeeba; padding:15px; border-radius:8px; margin-top:15px; color:#856404; font-size:1em; }

    /* CLICKABLE XATOLIK ELEMENTLARI */
    .clickable-error { cursor:pointer; color:#d9534f; text-decoration:underline; }
    .highlight-question { background: yellow !important; }
</style>
</head>
<body>
<header>GTI va NS kafedrasi</header>
<main>
    <div class="section">
        <h2>Sozlamalar</h2>
        <label>Raqamlash:</label>
        <select id="numbering"><option value="yes">Ha</option><option value="no">Yo‘q</option></select>

        <label>Variantlar (a, b, c…)</label>
        <select id="abcMode"><option value="yes">Ha</option><option value="no">Yo‘q</option></select>

        <label>Savollar orasida bo‘sh qator qo‘yilsinmi?</label>
        <select id="addEnter"><option value="yes">Ha</option><option value="no">Yo‘q</option></select>

        <label>Savol oldidagi belgi:</label>
        <input id="blockPrefix" value="++++">

        <label>To'g'ri javob oldidagi belgi:</label>
        <input id="firstPrefix" value="====#">

        <label>Noto'g'ri javob oldidagi belgi:</label>
        <input id="otherPrefix" value="====">
    </div>

    <div class="section">
        <h2>Savollarni kiriting</h2>
        <textarea id="inputText" placeholder="Savollarni kiriting..."></textarea>
        <button onclick="showResult()">Natijani Ko‘rish</button>
        <div id="errorDiv"></div>
    </div>
</main>

<div id="resultModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeModal()">&times;</span>
    <div id="modalText"></div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script>
function getABC(index){ return String.fromCharCode(97 + index) + ") "; }

function scrollToQuestion(index){
    let q = document.getElementById("q_" + index);
    if(!q) return;
    document.querySelectorAll('.highlight-question').forEach(e=>e.classList.remove('highlight-question'));
    q.classList.add('highlight-question');
    q.scrollIntoView({behavior:"smooth", block:"center"});
}

function customFormat(text, index, numbering, abcMode, blockPrefix, firstPrefix, otherPrefix){
    let lines = text.trim().split("\n");
    if(lines.length === 0) return [];

    let out = [];
    let title = lines[0];
    if(numbering === "yes") title = index + ". " + title;

    out.push(blockPrefix + title);
    for(let i=1; i<lines.length; i++){
        let line = lines[i];
        if(abcMode === "yes") line = getABC(i-1) + line;
        let prefix = (i === 1 ? firstPrefix : otherPrefix);
        out.push(prefix + line);
    }
    return out;
}

function splitBlocks(text){
    let lines = text.split("\n");
    let blocks = [], current = [];

    for(let i=0; i<lines.length; i++){
        let line = lines[i].trim();
        if(line === "") continue;
        if(line.endsWith("?") && current.length > 0){ blocks.push(current); current = [line]; }
        else current.push(line);
    }
    if(current.length>0) blocks.push(current);

    return blocks;
}

function extractKeywords(blocks){
    let keywordsMap = {};
    for(let i=0; i<blocks.length; i++){
        let firstAnswerI = blocks[i][1] ? blocks[i][1].split(/\s+/) : [];
        for(let j=0; j<blocks.length; j++){
            if(i===j) continue;
            let firstAnswerJ = blocks[j][1] ? blocks[j][1].split(/\s+/) : [];
            firstAnswerI.forEach(w1=>{
                firstAnswerJ.forEach(w2=>{
                    if(w1.toLowerCase()===w2.toLowerCase() && w1.length>2){
                        if(!keywordsMap[i]) keywordsMap[i] = new Set();
                        keywordsMap[i].add(w1);
                    }
                });
            });
        }
    }
    return keywordsMap;
}

function buildKeywordSignatures(keywordsMap){
    let sigMap = {};
    for(let idx in keywordsMap){
        let arr = Array.from(keywordsMap[idx]);
        if(arr.length === 0) continue;
        let norm = arr.map(w => w.trim()).filter(w=>w.length>0);
        norm.sort((a,b)=> a.toLowerCase().localeCompare(b.toLowerCase()));
        let signature = norm.join(", ");
        if(!sigMap[signature]) sigMap[signature] = { indices: [], words: norm };
        sigMap[signature].indices.push(parseInt(idx)+1);
    }
    return sigMap;
}

function extractRepeatedAnswers(blocks){
    let result = {};
    blocks.forEach((blk,i)=>{
        let answers = blk.slice(1);
        let map = {};
        answers.forEach((val,index)=>{
            let key = val.trim().toLowerCase();
            if(map[key]) map[key].push(String.fromCharCode(97+index));
            else map[key] = [String.fromCharCode(97+index)];
        });
        for(let key in map){
            if(map[key].length > 1){
                if(!result[i]) result[i] = [];
                result[i].push({letters:map[key], value:key});
            }
        }
    });
    return result;
}

function showResult(){
    let input = document.getElementById("inputText").value.trim();
    let numbering = document.getElementById("numbering").value;
    let abcMode = document.getElementById("abcMode").value;
    let addEnter = document.getElementById("addEnter").value;
    let blockPrefix = document.getElementById("blockPrefix").value;
    let firstPrefix = document.getElementById("firstPrefix").value;
    let otherPrefix = document.getElementById("otherPrefix").value;

    let blocks = splitBlocks(input);
    let modalDiv = document.getElementById("modalText");
    modalDiv.innerHTML = "";

    let fewAnswer = [], manyAnswer = [];

    blocks.forEach((blk,i)=>{
        let formatted = customFormat(blk.join("\n"), i+1, numbering, abcMode, blockPrefix, firstPrefix, otherPrefix);

        let qDiv = document.createElement("div");
        qDiv.className = "question";
        qDiv.id = "q_" + (i+1);
        qDiv.innerHTML = formatted[0];
        modalDiv.appendChild(qDiv);

        for(let j=1; j<formatted.length; j++){
            let aDiv = document.createElement("div");
            aDiv.className = "answer";
            aDiv.innerHTML = formatted[j];
            modalDiv.appendChild(aDiv);
        }

        if(addEnter === "yes" && i != blocks.length-1)
            modalDiv.appendChild(document.createElement("br"));

        let numAnswers = blk.length - 1;
        if(numAnswers < 4) fewAnswer.push({text:(i+1)+". savol: "+blk[0], index:(i+1)});
        else if(numAnswers > 4) manyAnswer.push({text:(i+1)+". savol: "+blk[0], index:(i+1)});
    });

    // Repeated answers
    let repeatedAnswers = extractRepeatedAnswers(blocks);
    if(Object.keys(repeatedAnswers).length>0){
        let div = document.createElement("div");
        div.innerHTML = "<strong>Takror javoblar aniqlangan:</strong><br>";
        for(let idx in repeatedAnswers){
            repeatedAnswers[idx].forEach(obj=>{
                let span = `<span class='clickable-error' onclick='scrollToQuestion(${parseInt(idx)+1})'>${parseInt(idx)+1} → ${obj.letters.join(" va ")} takrorlangan: '${obj.value}'</span><br>`;
                div.innerHTML += span;
            });
        }
        modalDiv.appendChild(div);
    }

    // Few answers
    if(fewAnswer.length>0){
        let div = document.createElement("div");
        div.innerHTML = "<strong>4 tadan kam javobli savollar:</strong><br>";
        fewAnswer.forEach(item=>{
            div.innerHTML += `<span class='clickable-error' onclick='scrollToQuestion(${item.index})'>${item.text}</span><br>`;
        });
        modalDiv.appendChild(div);
    }

    // Many answers
    if(manyAnswer.length>0){
        let div = document.createElement("div");
        div.innerHTML = "<strong>4 tadan ko‘p javobli savollar:</strong><br>";
        manyAnswer.forEach(item=>{
            div.innerHTML += `<span class='clickable-error' onclick='scrollToQuestion(${item.index})'>${item.text}</span><br>`;
        });
        modalDiv.appendChild(div);
    }

    // Repeated questions
    let questionMap = {};
    blocks.forEach((blk, index)=>{
        let qText = blk[0].trim();
        if(questionMap[qText]) questionMap[qText].push(index+1);
        else questionMap[qText] = [index+1];
    });
    let repeatedQuestions = [];
    for(let q in questionMap){ if(questionMap[q].length > 1) repeatedQuestions.push(questionMap[q]); }

    if(repeatedQuestions.length>0){
        let div = document.createElement("div");
        div.innerHTML = "<strong>Takror savollar:</strong><br>";
        repeatedQuestions.forEach(item=>{
            let nums = item.map(n=>`<span class='clickable-error' onclick='scrollToQuestion(${n})'>${n}</span>`).join(", ");
            div.innerHTML += nums + "<br>";
        });
        modalDiv.appendChild(div);
    }

    // Keywords per question
    let keywordsMap = extractKeywords(blocks);
    let sigMap = buildKeywordSignatures(keywordsMap);

    if(Object.keys(sigMap).length > 0){
        let groups = Object.keys(sigMap).map(sig=>{
            let arr = sigMap[sig].indices.slice().sort((a,b)=>a-b);
            return { signature: sig, indices: arr, words: sigMap[sig].words, minIndex: arr[0] };
        });
        groups.sort((a,b)=> a.minIndex - b.minIndex);

        let kwDiv = document.createElement("div");
        kwDiv.innerHTML = "<strong>Kalit so'zlar aniqlangan javoblar (guruhlangan):</strong><br>";

        groups.forEach(g=>{
            g.indices.forEach(idx=>{
                let span = document.createElement("span");
                span.className = "clickable-error";
                span.innerHTML = `${idx}. savol: ${g.signature}`;
                span.onclick = ()=>{ scrollToQuestion(idx); };
                kwDiv.appendChild(span);
                kwDiv.appendChild(document.createElement("br"));
            });
        });
        modalDiv.appendChild(kwDiv);
    }

    // Suspicious answers
    let suspicious = [];
    blocks.forEach((blk,i)=>{
        if(blk.length < 2) return;

        let answers = blk.slice(1);
        let firstAnswer = answers[0];
        let countUpper = 0, countLower = 0;

        answers.forEach(a=>{
            if(a[0] === a[0].toUpperCase()) countUpper++;
            else countLower++;
        });

        let isSuspicious = false;
        if(countUpper === answers.length) isSuspicious = false;
        else if(
            (firstAnswer[0] === firstAnswer[0].toUpperCase() && countLower >= 3) ||
            (firstAnswer[0] === firstAnswer[0].toLowerCase() && countUpper === answers.length-1) ||
            (countUpper === 2 && countLower === 2)
        ) isSuspicious = true;

        if(isSuspicious) suspicious.push({text:(i+1)+". savоl: "+blk[0], index:(i+1)});
    });

    if(suspicious.length>0){
        let susDiv = document.createElement("div");
        susDiv.innerHTML = "<strong>Kichik/bosh harflar tufayli shubhali javoblar:</strong><br>";
        susDiv.style.color = "orange";

        suspicious.forEach(item=>{
            susDiv.innerHTML += `<span class='clickable-error' onclick='scrollToQuestion(${item.index})'>${item.text}</span><br>`;
        });

        modalDiv.appendChild(susDiv);
    }

    document.getElementById("resultModal").style.display = "block";
}

function downloadResult(format){
    let modalDiv = document.getElementById("modalText");
    if(!modalDiv.innerHTML.trim()){ alert("Natija mavjud emas!"); return; }

    let htmlContent = modalDiv.innerHTML.replace(/<div class=\"question\">/g, "")
                                        .replace(/<div class=\"answer\">/g, "")
                                        .replace(/<\/div>/g, "")
                                        .replace(/<br>/g, "\n");

    if(format === 'txt'){
        let blob = new Blob([htmlContent], { type:"text/plain;charset=utf-8" });
        let link = document.createElement("a"); link.href = URL.createObjectURL(blob);
        link.download = "natija.txt"; link.click();
    }
    else if(format === 'doc'){
        let docHtml = "<html><head><meta charset='UTF-8'></head><body>" + modalDiv.innerHTML + "</body></html>";
        let blob = new Blob([docHtml], { type:"application/msword" });
        let link = document.createElement("a"); link.href = URL.createObjectURL(blob);
        link.download = "natija.doc"; link.click();
    }
    else if(format === 'xlsx'){
        let wb = XLSX.utils.book_new(); let rows = [];
        modalDiv.querySelectorAll(".question, .answer, .keyword, .repeat").forEach(el=>{ rows.push([el.textContent]); });
        XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(rows), "Natija");
        XLSX.writeFile(wb, "natija.xlsx");
    }
}

function closeModal(){ document.getElementById("resultModal").style.display = "none"; }
window.onclick = function(event){ if(event.target == document.getElementById("resultModal")) closeModal(); }
</script>

<div style="padding:25px; max-width:950px; margin:auto;">
    <button onclick="downloadResult('txt')">Yuklab olish (TXT)</button>
    <button onclick="downloadResult('doc')">Yuklab olish (DOC)</button>
    <button onclick="downloadResult('xlsx')">Yuklab olish (Excel)</button>
</div>

</body>
</html>
